webswingRequirejs.define(["jquery","text!templates/upload.html","jquery.iframe-transport","jquery.fileupload"],function(t,n){return function(){function P(e){e.eventType==="AutoUpload"?H(e,i.socketId):e.eventType==="AutoSave"?B(e,i.socketId):e.eventType==="Open"?j(e,i.socketId):e.eventType==="Close"&&F()}function H(e,t){N==null&&I(i),N.closest(i.cfg.rootElement).length===0&&i.cfg.rootElement.append(N),o=[],u=[],A.val(t),k.prop("multiple",e.isMultiSelection),k.attr("accept",e.filter),W(!1),q(N)}function B(e,t){O==null&&I(i),O.closest(i.cfg.rootElement).length===0&&i.cfg.rootElement.append(O),M.val(e.selection),q(O)}function j(e,t){l=!1,c==null&&I(i),c.closest(i.cfg.rootElement).length===0&&i.cfg.rootElement.append(c),h.val(t),z(g,d,e.allowDownload),z(x,d,e.allowUpload),z(m,d,e.allowDelete),U(y,e.allowUpload),U(S,e.allowDownload||e.allowUpload||e.allowDelete),T.prop("multiple",e.isMultiSelection),T.attr("accept",e.filter),W(!1),U(c,e.allowDownload||e.allowUpload||e.allowDelete)}function F(){c!=null&&c.closest(i.cfg.rootElement).length!==0&&(f?l=!0:(c.hide("fast"),c.detach())),N!=null&&N.closest(i.cfg.rootElement).length!==0&&(N.hide("fast"),N.detach()),O!=null&&O.closest(i.cfg.rootElement).length!==0&&(O.hide("fast"),O.detach())}function I(){function P(e,t){t.form.fileupload({url:i.cfg.connectionUrl+"file?uuid="+i.socketId()}),t.files.forEach(function(e){o.push(e.name)}),s.push(t),W(!0)}function H(e,t){W(!1),t.jqXHR.statusText!="abort"&&(f?(v.append("<p>"+t.jqXHR.responseText+"</p>"),clearTimeout(f)):(v.append("<p>"+t.jqXHR.responseText+"</p>"),q(p)),t.files.forEach(function(e){var t=o.indexOf(e.name);o.splice(t,1)}),f=setTimeout(function(){f=null,v.html(""),p.hide("fast"),l&&F()},3e3))}function B(e,n){var r=parseInt(n.loaded/n.total*100,10),i=t(".ws-progress-bar"),s=t(".ws-progress-text");i.css("width",r+"%"),s.find("em").text(r+"%")}function j(e,n){var r=t(".ws-progress-text");r.find("em").text(i.translate("files.progComplete"));var a=n.result.files[0].name;u.push(a),o.splice(o.indexOf(a),1),!f&&o.length==0&&(X(u),u=[],W(!1),s=[])}function I(e,t){return e.length===t.length&&e.sort().every(function(e,n){return e===t.sort()[n]})}function R(e){V("cancelFileSelection"),U()}function U(){X([]),s.forEach(function(e){e.abort()}),W(!1)}function z(){var e=M.val();return e.match(/^[a-zA-Z0-9. _-]*$/)?(v.html(""),p.hide("fast"),!0):(v.html(i.translate("<p>${files.saveInvlidFilename}</p>")),q(p),!1)}i.cfg.rootElement.append(n),c=i.cfg.rootElement.find('div[data-id="uploadBar"]'),h=c.find('input[data-id="fileDialogTransferBarClientId"]'),d=c.find('div[data-id="fileActionButtonGroup"]'),m=c.find('button[data-id="deleteSelectedButton"]'),g=c.find('button[data-id="downloadSelectedButton"]'),x=c.find('div[data-id="fileUploadBtn"]'),y=c.find('div[data-id="fileDropArea"]'),b=c.find('form[data-id="fileupload"]'),S=c.find('button[data-id="cancelBtn"]'),T=c.find('input[data-id="fileInput"]'),w=i.cfg.rootElement.find('div[data-id="fileDialogTransferProgressBar"]'),E=i.cfg.rootElement.find('div[data-id="progress"] .ws-progress-bar'),p=i.cfg.rootElement.find('div[data-id="fileDialogErrorMessage"]'),v=i.cfg.rootElement.find('div[data-id="fileDialogErrorMessageContent"]'),N=i.cfg.rootElement.find('div[data-id="autoUploadBar"]'),C=N.find('form[data-id="autoFileupload"]'),L=N.find('button[data-id="cancelAutoUploadButton"]'),k=N.find('input[data-id="autoFileInput"]'),A=N.find('input[data-id="autoUploadfileDialogTransferBarClientId"]'),O=i.cfg.rootElement.find('div[data-id="autoSaveBar"]'),M=O.find('input[data-id="autoSaveInput"]'),D=O.find('button[data-id="autoSaveButton"]'),_=O.find('button[data-id="cancelAutoSaveButton"]'),w.hide(),N.hide(),N.detach(),O.hide(),O.detach(),c.hide(),c.detach();var e=C.fileupload({xhrFields:{withCredentials:!0},url:i.cfg.connectionUrl+"file",dataType:"json",dropZone:null});e.bind("fileuploadfail",H),e.bind("fileuploadprogressall",B),e.bind("fileuploadadd",P),e.bind("fileuploaddone",j);var r=b.fileupload({xhrFields:{withCredentials:!0},url:i.cfg.connectionUrl+"file",dataType:"json",dropZone:y});r.bind("fileuploadfail",H),r.bind("fileuploadprogressall",B),r.bind("fileuploadadd",P),r.bind("fileuploaddone",j),_.bind("click",R),L.bind("click",R),S.bind("click",R),m.bind("click",function(e){V("deleteFile")}),g.bind("click",function(e){V("downloadFile")}),i.cfg.rootElement.bind("drop",function(e){e.preventDefault()}),M.bind("input",z),D.bind("click",function(e){var t=M.val();z()&&t.length>0&&X([t])}),i.cfg.rootElement.bind("dragover",function(e){a?clearTimeout(a):y.addClass("ws-filebar-dropArea--ondrag"),a=setTimeout(function(){a=null,y.removeClass("ws-filebar-dropArea--ondrag")},100)})}function q(e){e.show("fast")}function R(e){e.hide("fast")}function U(e,t){t?q(e):R(e)}function z(e,t,n){e.detach(),n&&t.append(e)}function W(e){e?(E.css("width","0%"),w.fadeIn(200)):(w.fadeOut(200),E.css("width","0%"))}function X(e){i.send({selected:{files:e}})}function V(e){i.send({events:[{event:{type:e}}]})}function J(e){var t="hiddenDownloader"+e,n=document.getElementById(t);n!=null&&n.parentNode.removeChild(n),n=document.createElement("iframe"),n.id=t,n.style.display="none",document.body.appendChild(n),n.src=i.cfg.connectionUrl+e}function K(e){window.open(e,"_blank")}function Q(e){window.open(i.cfg.connectionUrl+"print/viewer.html?file="+encodeURIComponent(i.cfg.connectionUrl+e),"_blank")}var r=this,i;r.injects=i={cfg:"webswing.config",socketId:"socket.uuid",send:"socket.send",translate:"translate.translate"},r.provides={process:P,close:F,download:J,link:K,print:Q},r.ready=function(){n=i.translate(n)};var s=[],o=[],u=[],a,f,l,c,h,p,d,v,m,g,y,b,w,E,S,x,T,N,C,k,L,A,O,M,_,D}});