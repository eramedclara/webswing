webswingRequirejs.define(["webswing-dd","webswing-util"],function(t,n){return function(){function h(){d(null,!1)}function p(e){d(e,!0)}function d(e,t){i.registerInput(),i.registerTouch(),window.addEventListener("beforeunload",v),t||window.addEventListener("hashchange",T),g(),i.cfg.clientId=e,i.cfg.canPaint=!0,i.cfg.hasControl=!t,i.cfg.mirrorMode=t,T(),t&&w(),i.showDialog(i.startingDialog)}function v(e){N()}function m(){i.hideDialog(),i.cfg.canPaint=!0,T(),w(),E()}function g(){i.cfg.clientId="",i.cfg.viewId=n.GUID(),i.cfg.hasControl=!1,i.cfg.mirrorMode=!1,i.cfg.canPaint=!1,clearInterval(s),clearInterval(o),s=setInterval(i.sendInput,100),o=setInterval(b,1e5),l={},c.dispose(),c=new t({logTrace:i.cfg.traceLog,logDebug:i.cfg.debugLog,ieVersion:i.cfg.ieVersion,dpr:n.dpr})}function y(e){i.sendInput({event:{type:e}})}function b(){i.touchSession()}function w(){y("repaint")}function E(e){y("paintAck"),e!=null&&i.sendInput({timestamps:{startTimestamp:e.startTimestamp,sendTimestamp:e.sendTimestamp,renderingTime:""+((new Date).getTime()-e.receivedTimestamp)}})}function S(){i.cfg.hasControl&&y("killSwing")}function x(){i.cfg.mirrorMode||y("unload")}function T(){i.sendInput(j(i.getCanvas()))}function N(){clearInterval(s),x(),i.sendInput(),g(),i.closeFileDialog(),i.hideDialogBar(),window.removeEventListener("beforeunload",v),c.dispose()}function C(e){e.playback!=null&&i.playbackInfo(e);if(e.applications!=null&&e.applications.length!=0){i.cfg.mirror?p(i.cfg.clientId):e.applications.length===1&&h();return}if(e.event!=null&&!i.cfg.recordingPlayback){if(e.event=="shutDownAutoLogoutNotification")i.disconnect(),i.cfg.mirror==0&&i.logout();else if(e.event=="shutDownNotification")i.currentDialog()!==i.timedoutDialog&&i.showDialog(i.stoppedDialog),i.disconnect();else if(e.event=="applicationAlreadyRunning")i.showDialog(i.applicationAlreadyRunning);else if(e.event=="tooManyClientsNotification")i.showDialog(i.tooManyClientsNotification);else if(e.event=="continueOldSession"){m();var t=i.dialogBarContent();i.showDialogBar(i.continueOldSessionDialog),i.dialogBarContent().focused=!1,window.setTimeout(function(){i.dialogBarContent()!=null&&!i.dialogBarContent().focused&&(i.hideDialogBar(),i.showDialogBar(t))},5e3)}else e.event=="sessionStolenNotification"?(i.cfg.canPaint=!1,i.showDialog(i.sessionStolenNotification)):e.event=="unauthorizedAccess"?(i.cfg.canPaint=!1,i.showDialog(i.unauthorizedAccess)):e.event=="sessionTimeoutWarning"?(window.clearTimeout(f),i.showDialogBar(i.inactivityTimeoutWarningDialog),f=window.setTimeout(function(){i.hideDialogBar()},2e3)):e.event=="sessionTimedOutNotification"?(i.showDialog(i.timedoutDialog),i.disconnect()):e.event=="applicationBusy"&&i.currentDialog()==null&&i.showDialog(i.applicationBusyDialog);return}e.jsRequest!=null&&i.cfg.mirrorMode==0&&!i.cfg.recordingPlayback&&i.processJsLink(e.jsRequest);if(e.pixelsRequest!=null&&i.cfg.mirrorMode==0&&!i.cfg.recordingPlayback){var n=F(e.pixelsRequest);i.send(n)}i.cfg.canPaint&&k(e)}function k(e){a.push(e),u||L()}function L(){u=null;if(a.length>0){u=a.shift();try{A(i.getCanvas(),u)}catch(e){throw u=null,e}}}function A(e,t){t.windows!=null&&t.windows.length>0&&i.hideDialog();var n=e.getContext("2d");t.linkAction!=null&&!i.cfg.recordingPlayback&&(t.linkAction.action=="url"?i.openLink(t.linkAction.src):t.linkAction.action=="print"?i.print("file?id="+t.linkAction.src):t.linkAction.action=="file"?i.download("file?id="+t.linkAction.src):t.linkAction.action=="redirect"&&!i.cfg.mirrorMode&&(window.location.href=t.linkAction.src)),t.moveAction!=null&&H(t.moveAction.sx,t.moveAction.sy,t.moveAction.dx,t.moveAction.dy,t.moveAction.width,t.moveAction.height,n);if(t.focusEvent!=null){var r=i.getInput();t.focusEvent.type==="focusWithCarretGained"?(r.style.top=t.focusEvent.y+t.focusEvent.caretY+"px",r.style.left=t.focusEvent.x+t.focusEvent.caretX+"px"):(r.style.top=null,r.style.left=null)}t.cursorChange!=null&&i.cfg.hasControl&&!i.cfg.recordingPlayback&&(e.style.cursor=B(t.cursorChange)),t.copyEvent!=null&&i.cfg.hasControl&&!i.cfg.recordingPlayback&&i.displayCopyBar(t.copyEvent),t.pasteRequest!=null&&i.cfg.hasControl&&!i.cfg.recordingPlayback&&i.displayPasteDialog(t.pasteRequest),t.fileDialogEvent!=null&&i.cfg.hasControl&&!i.cfg.recordingPlayback&&i.processFileDialogEvent(t.fileDialogEvent),t.closedWindow!=null&&delete l[t.closedWindow.id];for(var s in t.windows){var o=t.windows[s];if(o.id=="BG"){(i.cfg.mirrorMode||i.cfg.recordingPlayback)&&D(e,o.width,o.height);for(var u in o.content){var a=o.content[u];a!=null&&P(o.posX+a.positionX,o.posY+a.positionY,a.width,a.height,n)}t.windows.splice(s,1);break}}t.windows!=null?t.windows.reduce(function(e,t){return e.then(function(){return O(t,n)},I)},Promise.resolve()).then(function(){E(t),L()},I):L()}function O(e,t){return e.directDraw!=null?_(e,t):M(e,t)}function M(e,t){return e.content.reduce(function(r,s){return r.then(function(){return new Promise(function(r,o){if(s!=null){var u=new Image,a=function(){t.save(),t.setTransform(n.dpr,0,0,n.dpr,0,0),t.drawImage(u,e.posX+s.positionX,e.posY+s.positionY),t.restore(),r(),u.onload=null,u.src="",u.clearAttributes!=null&&u.clearAttributes(),u=null};u.onload=function(){i.cfg.ieVersion&&i.cfg.ieVersion<=10?window.setTimeout(a,20):a()},u.src=n.getImageString(s.base64Content)}})},I)},Promise.resolve())}function _(e,t){return new Promise(function(r,i){var s;typeof e.directDraw=="string"?s=c.draw64(e.directDraw,l[e.id]):s=c.drawBin(e.directDraw,l[e.id]),s.then(function(i){l[e.id]=i;var s=n.dpr;for(var o in e.content){var u=e.content[o];if(u!=null){var a=Math.min(i.width,Math.max(0,u.positionX*s)),f=Math.min(i.height,Math.max(0,u.positionY*s)),c=Math.min(i.width-a,u.width*s-(a-u.positionX*s)),h=Math.min(i.height-f,u.height*s-(f-u.positionY*s)),p=e.posX*s+a,d=e.posY*s+f,v=c,m=h;p<=t.canvas.width&&d<=t.canvas.height&&p+v>0&&d+m>0&&t.drawImage(i,a,f,c,h,p,d,v,m)}}r()},function(e){i(e)})})}function D(e,t,r){if(e.width!=t*n.dpr||e.height!=r*n.dpr){var i=e.getContext("2d"),s;e.width!==0&&e.height!=0&&(s=i.getImageData(0,0,e.width,e.height)),e.width=t*n.dpr,e.height=r*n.dpr,e.style.width=t+"px",e.style.height=r+"px",s!=null&&i.putImageData(s,0,0)}}function P(e,t,r,i,s){var o=n.dpr;s.clearRect(e*o,t*o,r*o,i*o)}function H(e,t,r,i,s,o,u){var a=n.dpr,f=u.getImageData(e*a,t*a,s*a,o*a);u.putImageData(f,r*a,i*a)}function B(e){if(e.b64img==null)return e.cursor;if(i.cfg.ieVersion)return"url('"+i.cfg.connectionUrl+"file?id="+e.curFile+"'), auto";var t=n.getImageString(e.b64img);return"url("+t+") "+e.x+" "+e.y+" , auto"}function j(e){var t={clientId:i.cfg.clientId,browserId:i.getIdentity(),viewId:i.cfg.viewId,connectionId:i.getSocketId(),locale:i.getLocale(),timeZone:n.getTimeZone(),mirrored:i.cfg.mirrorMode,directDrawSupported:i.cfg.typedArraysSupported&&!(i.cfg.ieVersion&&i.cfg.ieVersion<=10),url:window.location.href};return i.cfg.mirrorMode||(t.documentBase=i.cfg.documentBase,t.params=i.cfg.params,t.desktopWidth=e.offsetWidth,t.desktopHeight=e.offsetHeight),{handshake:t}}function F(e){var t=document.createElement("canvas");t.width=e.w,t.height=e.h;var n=i.getCanvas().getContext("2d"),r=n.getImageData(e.x,e.y,e.h,e.w),s=t.getContext("2d");s.putImageData(r,0,0);var o=t.toDataURL("image/png");return{pixelsResponse:{correlationId:e.correlationId,pixels:o}}}function I(e){throw u=null,e}var r=this,i;r.injects=i={cfg:"webswing.config",disconnect:"webswing.disconnect",getSocketId:"socket.uuid",send:"socket.send",getCanvas:"canvas.get",getInput:"canvas.getInput",registerInput:"input.register",sendInput:"input.sendInput",registerTouch:"touch.register",getUser:"login.user",login:"login.login",logout:"login.logout",touchSession:"login.touchSession",getIdentity:"identity.get",disposeIdentity:"identity.dispose",getLocale:"translate.getLocale",showDialog:"dialog.show",showDialogBar:"dialog.showBar",hideDialog:"dialog.hide",hideDialogBar:"dialog.hideBar",dialogBarContent:"dialog.currentBar",currentDialog:"dialog.current",startingDialog:"dialog.content.startingDialog",stoppedDialog:"dialog.content.stoppedDialog",timedoutDialog:"dialog.content.timedoutDialog",unauthorizedAccess:"dialog.content.unauthorizedAccess",applicationAlreadyRunning:"dialog.content.applicationAlreadyRunning",sessionStolenNotification:"dialog.content.sessionStolenNotification",tooManyClientsNotification:"dialog.content.tooManyClientsNotification",continueOldSessionDialog:"dialog.content.continueOldSessionDialog",inactivityTimeoutWarningDialog:"dialog.content.inactivityTimeoutWarningDialog",applicationBusyDialog:"dialog.content.applicationBusyDialog",processFileDialogEvent:"files.process",closeFileDialog:"files.close",openLink:"files.link",print:"files.print",download:"files.download",displayCopyBar:"clipboard.displayCopyBar",displayPasteDialog:"clipboard.displayPasteDialog",processJsLink:"jslink.process",playbackInfo:"playback.playbackInfo"},r.provides={startApplication:h,startMirrorView:p,continueSession:m,kill:S,handshake:T,processMessage:C,dispose:N,repaint:w},r.ready=function(){c=new t({logTrace:i.cfg.traceLog,logDebug:i.cfg.debugLog,ieVersion:i.cfg.ieVersion,dpr:n.dpr})};var s,o,u,a=[],f=null,l={},c}});