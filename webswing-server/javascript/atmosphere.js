/*
 * Copyright 2018 Async-IO.org
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

(function(e,t){typeof webswingRequirejs.define=="function"&&webswingRequirejs.define.amd?webswingRequirejs.define(t):typeof exports!="undefined"?module.exports=t():e.atmosphere=t()})(this,function(){var e={},t,n=!1,r=[],i=[],s=0,o=Object.prototype.hasOwnProperty;return e={version:"2.3.8-javascript",onError:function(e){},onClose:function(e){},onOpen:function(e){},onReopen:function(e){},onMessage:function(e){},onReconnect:function(e,t){},onMessagePublished:function(e){},onTransportFailure:function(e,t){},onLocalMessage:function(e){},onFailureToReconnect:function(e,t){},onClientTimeout:function(e){},onOpenAfterResume:function(e){},WebsocketApiAdapter:function(t){var n,r;return t.onMessage=function(e){r.onmessage({data:e.responseBody})},t.onMessagePublished=function(e){r.onmessage({data:e.responseBody})},t.onOpen=function(e){r.onopen(e)},r={close:function(){n.close()},send:function(e){n.push(e)},onmessage:function(e){},onopen:function(e){},onclose:function(e){},onerror:function(e){}},n=new e.subscribe(t),r},AtmosphereRequest:function(t){function T(){h=!0,m=!1,p=0,u=null,a=null,f=null,l=null}function N(){M(),T()}function C(e){return e=="debug"?r.logLevel==="debug":e=="info"?r.logLevel==="info"||r.logLevel==="debug":e=="warn"?r.logLevel==="warn"||r.logLevel==="info"||r.logLevel==="debug":e=="error"?r.logLevel==="error"||r.logLevel==="warn"||r.logLevel==="info"||r.logLevel==="debug":!1}function k(t){C("debug")&&e.util.debug(new Date+" Atmosphere: "+t)}function L(e,t){return o.partialMessage===""&&t.transport==="streaming"&&e.responseText.length>t.maxStreamingLength?!0:!1}function A(){if(r.enableProtocol&&!r.disableDisconnect&&!r.firstMessage){var t="X-Atmosphere-Transport=close&X-Atmosphere-tracking-id="+r.uuid;e.util.each(r.headers,function(n,i){var s=e.util.isFunction(i)?i.call(this,r,r,o):i;s!=null&&(t+="&"+encodeURIComponent(n)+"="+encodeURIComponent(s))});var n=r.url.replace(/([?&])_=[^&]*/,t);n+=n===r.url?(/\?/.test(r.url)?"&":"?")+t:"";var i={connected:!1},s=new e.AtmosphereRequest(i);s.connectTimeout=r.connectTimeout,s.attachHeadersAsQueryString=!1,s.dropHeaders=!0,s.url=n,s.contentType="text/plain",s.transport="polling",s.method="GET",s.data="",s.heartbeat=null,r.enableXDR&&(s.enableXDR=r.enableXDR),s.async=r.closeAsync,ht("",s)}}function O(){k("Closing (AtmosphereRequest._close() called)"),m=!0,r.reconnectId&&(clearTimeout(r.reconnectId),delete r.reconnectId),r.heartbeatTimer&&clearTimeout(r.heartbeatTimer),r.reconnect=!1,o.request=r,o.state="unsubscribe",o.responseBody="",o.status=408,o.partialMessage="",r.curWebsocketErrorRetries=0,kt(),A(),M()}function M(){o.partialMessage="",r.id&&clearTimeout(r.id),r.heartbeatTimer&&clearTimeout(r.heartbeatTimer),r.reconnectId&&(clearTimeout(r.reconnectId),delete r.reconnectId),l!=null&&(l.close(),l=null),c!=null&&(c.abort(),c=null),f!=null&&(f.abort(),f=null),u!=null&&(u.canSendMessage&&(k("invoking .close() on WebSocket object"),u.close()),u=null),a!=null&&(a.close(),a=null),_()}function _(){y!=null&&(clearInterval(E),document.cookie=S+"=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/",y.signal("close",{reason:"",heir:m?(y.get("children")||[])[0]:w}),y.close()),b!=null&&b.close()}function D(t){N(),r=e.util.extend(r,t),r.mrequest=r.reconnect,r.reconnect||(r.reconnect=!0)}function P(){return r.webSocketImpl!=null||window.WebSocket||window.MozWebSocket}function H(){var t=e.util.getAbsoluteURL(r.url.toLowerCase()),n=/^([\w\+\.\-]+:)(?:\/\/([^\/?#:]*)(?::(\d+))?)?/.exec(t),i=!(!n||n[1]==window.location.protocol&&n[2]==window.location.hostname&&(n[3]||(n[1]==="http:"?80:443))==(window.location.port||(window.location.protocol==="http:"?80:443)));return window.EventSource&&(!i||!e.util.browser.safari||e.util.browser.vmajor>=7)}function B(){if(r.shared){b=j(r);if(b!=null){C("debug")&&e.util.debug("Storage service available. All communication will be local");if(b.open(r))return}C("debug")&&e.util.debug("No Storage service available."),b=null}r.firstMessage=s==0?!0:!1,r.isOpen=!1,r.ctime=e.util.now(),r.uuid===0&&(r.uuid=s),o.closedByClientTimeout=!1,r.transport!=="websocket"&&r.transport!=="sse"?tt(r):r.transport==="websocket"?P()?X(!1):G("Websocket is not supported, using request.fallbackTransport ("+r.fallbackTransport+")"):r.transport==="sse"&&(H()?W(!1):G("Server Side Events(SSE) is not supported, using request.fallbackTransport ("+r.fallbackTransport+")"))}function j(t){function a(e,t){var n,r=e.length;for(n=0;n<r;n++)e[n]===t&&e.splice(n,1);return r!==e.length}function f(e){var n=JSON.parse(e),i=n.data;if(n.target==="c")switch(n.type){case"open":I("opening","local",r);break;case"close":s||(s=!0,i.reason==="aborted"?O():i.heir===w?B():setTimeout(function(){B()},100));break;case"message":St(i,"messageReceived",200,t.transport);break;case"localMessage":Et(i)}}function l(){var e=(new RegExp("(?:^|; )("+encodeURIComponent(o)+")=([^;]*)")).exec(document.cookie);if(e)return JSON.parse(decodeURIComponent(e[2]))}var n,i,s,o="atmosphere-"+t.url,u={storage:function(){function n(e){e.key===o&&e.newValue&&f(e.newValue)}if(!e.util.storage)return;var r=window.localStorage,i=function(e){var t=r.getItem(o+"-"+e);return t===null?[]:JSON.parse(t)},s=function(e,t){r.setItem(o+"-"+e,JSON.stringify(t))};return{init:function(){return s("children",i("children").concat([w])),e.util.on(window,"storage",n),i("opened")},signal:function(e,t){r.setItem(o,JSON.stringify({target:"p",type:e,data:t}))},close:function(){var r=i("children");e.util.off(window,"storage",n),r&&a(r,t.id)&&s("children",r)}}},windowref:function(){var e=window.open("",o.replace(/\W/g,""));if(!e||e.closed||!e.callbacks)return;return{init:function(){return e.callbacks.push(f),e.children.push(w),e.opened},signal:function(t,n){!e.closed&&e.fire&&e.fire(JSON.stringify({target:"p",type:t,data:n}))},close:function(){s||(a(e.callbacks,f),a(e.children,w))}}}};n=l();if(!n||e.util.now()-n.ts>1e3)return;i=u.storage()||u.windowref();if(!i)return;return{open:function(){var e;return E=setInterval(function(){var e=n;n=l(),(!n||e.ts===n.ts)&&f(JSON.stringify({target:"c",type:"close",data:{reason:"error",heir:e.heir}}))},1e3),e=i.init(),e&&setTimeout(function(){I("opening","local",t)},50),e},send:function(e){i.signal("send",e)},localSend:function(e){i.signal("localSend",JSON.stringify({id:w,event:e}))},close:function(){m||(clearInterval(E),i.signal("close"),i.close())}}}function F(){function s(e){var t=JSON.parse(e),n=t.data;if(t.target==="p")switch(t.type){case"send":ct(n);break;case"localSend":Et(n);break;case"close":O()}}function o(){document.cookie=S+"="+encodeURIComponent(JSON.stringify({ts:e.util.now()+1,heir:(t.get("children")||[])[0]}))+"; path=/"}var t,n="atmosphere-"+r.url,i={storage:function(){function t(e){e.key===n&&e.newValue&&s(e.newValue)}if(!e.util.storage)return;var r=window.localStorage;return{init:function(){e.util.on(window,"storage",t)},signal:function(e,t){r.setItem(n,JSON.stringify({target:"c",type:e,data:t}))},get:function(e){return JSON.parse(r.getItem(n+"-"+e))},set:function(e,t){r.setItem(n+"-"+e,JSON.stringify(t))},close:function(){e.util.off(window,"storage",t),r.removeItem(n),r.removeItem(n+"-opened"),r.removeItem(n+"-children")}}},windowref:function(){var e=n.replace(/\W/g,""),t=document.getElementById(e),r;return t||(t=document.createElement("div"),t.id=e,t.style.display="none",t.innerHTML='<iframe name="'+e+'" />',document.body.appendChild(t)),r=t.firstChild.contentWindow,{init:function(){r.callbacks=[s],r.fire=function(e){var t;for(t=0;t<r.callbacks.length;t++)r.callbacks[t](e)}},signal:function(e,t){!r.closed&&r.fire&&r.fire(JSON.stringify({target:"c",type:e,data:t}))},get:function(e){return r.closed?null:r[e]},set:function(e,t){r.closed||(r[e]=t)},close:function(){}}}};g=function(n){t.signal("message",n)},t=i.storage()||i.windowref(),t.init(),C("debug")&&e.util.debug("Installed StorageService "+t),t.set("children",[]),t.get("opened")!=null&&!t.get("opened")&&t.set("opened",!1),S=encodeURIComponent(n),o(),E=setInterval(o,1e3),y=t}function I(e,t,n){r.shared&&t!=="local"&&F(),y!=null&&y.set("opened",!0),n.close=function(){O()};if(p>0&&e==="re-connecting")n.isReopen=!0,st(o);else if(o.error==null){o.request=n;var i=o.state;o.state=e;var s=o.transport;o.transport=t;var u=o.responseBody;kt(),o.responseBody=u,o.state=i,o.transport=s}}function q(t){t.transport="jsonp";var n=r,i;t!=null&&typeof t!="undefined"&&(n=t),c={open:function(){function u(){n.lastIndex=0,n.openId&&clearTimeout(n.openId),n.heartbeatTimer&&clearTimeout(n.heartbeatTimer),n.reconnect&&p++<n.maxReconnectOnClose?(I("re-connecting",n.transport,n),it(c,n,t.reconnectInterval),n.openId=setTimeout(function(){Z(n)},n.reconnectInterval+1e3)):K(0,"maxReconnectOnClose reached")}function a(){var e=n.url;n.dispatchUrl!=null&&(e+=n.dispatchUrl);var r=n.data;n.attachHeadersAsQueryString&&(e=Y(n),r!==""&&(e+="&X-Atmosphere-Post-Body="+encodeURIComponent(r)),r="");var o=document.head||document.getElementsByTagName("head")[0]||document.documentElement;i=document.createElement("script"),i.src=e+"&jsonpTransport="+s,i.clean=function(){i.clean=i.onerror=i.onload=i.onreadystatechange=null,i.parentNode&&i.parentNode.removeChild(i),++t.scriptCount===2&&(t.scriptCount=1,u())},i.onload=i.onreadystatechange=function(){k("jsonp.onload"),(!i.readyState||/loaded|complete/.test(i.readyState))&&i.clean()},i.onerror=function(){k("jsonp.onerror"),t.scriptCount=1,i.clean()},o.insertBefore(i,o.firstChild)}var s="atmosphere"+ ++w;window[s]=function(i){k("jsonp.window"),t.scriptCount=0;if(n.reconnect&&n.maxRequest===-1||n.requestCount++<n.maxRequest){n.executeCallbackBeforeReconnect||it(c,n,n.pollingInterval);if(i!=null&&typeof i!="string")try{i=i.message}catch(s){}var u=Q(i,n,o);u||St(o.responseBody,"messageReceived",200,n.transport),n.executeCallbackBeforeReconnect&&it(c,n,n.pollingInterval),$(n)}else e.util.log(r.logLevel,["JSONP reconnect maximum try reached "+r.requestCount]),K(0,"maxRequest reached")},setTimeout(function(){a()},50)},abort:function(){i&&i.clean&&i.clean()}},c.open()}function R(e){return r.webSocketImpl!=null?r.webSocketImpl:window.WebSocket?new WebSocket(e):new MozWebSocket(e)}function U(){return Y(r,e.util.getAbsoluteURL(r.webSocketUrl||r.url)).replace(/^http/,"ws")}function z(){var e=Y(r);return e}function W(t){o.transport="sse";var n=z();C("debug")&&(e.util.debug("Invoking executeSSE"),e.util.debug("Using URL: "+n));if(t&&!r.reconnect){a!=null&&M();return}try{a=new EventSource(n,{withCredentials:r.withCredentials})}catch(i){K(0,i),G("SSE failed. Downgrading to fallback transport and resending");return}r.connectTimeout>0&&(r.id=setTimeout(function(){t||M()},r.connectTimeout)),a.onopen=function(n){k("sse.onopen"),$(r),C("debug")&&e.util.debug("SSE successfully opened"),r.enableProtocol?r.isReopen&&(r.isReopen=!1,I("re-opening",r.transport,r)):t?I("re-opening","sse",r):I("opening","sse",r),t=!0,r.method==="POST"&&(o.state="messageReceived",ct(r.data))},a.onmessage=function(t){k("sse.onmessage"),$(r);if(!r.enableXDR&&window.location.host&&t.origin&&t.origin!==window.location.protocol+"//"+window.location.host){e.util.log(r.logLevel,["Origin was not "+window.location.protocol+"//"+window.location.host]);return}o.state="messageReceived",o.status=200,t=t.data;var n=Q(t,r,o);n||(kt(),o.responseBody="",o.messages=[])},a.onerror=function(n){k("sse.onerror"),clearTimeout(r.id),r.heartbeatTimer&&clearTimeout(r.heartbeatTimer);if(o.closedByClientTimeout)return;Ct(t),M(),m?e.util.log(r.logLevel,["SSE closed normally"]):t?r.reconnect&&o.transport==="sse"&&(p++<r.maxReconnectOnClose?(I("re-connecting",r.transport,r),r.reconnectInterval>0?r.reconnectId=setTimeout(function(){W(!0)},r.reconnectInterval):W(!0),o.responseBody="",o.messages=[]):(e.util.log(r.logLevel,["SSE reconnect maximum try reached "+p]),K(0,"maxReconnectOnClose reached"))):G("SSE failed. Downgrading to fallback transport and resending")}}function X(t){o.transport="websocket";var i=U(r.url);C("debug")&&e.util.debug("Invoking executeWebSocket, using URL: "+i);if(t&&!r.reconnect){u!=null&&M();return}u=R(i),r.webSocketBinaryType!=null&&(u.binaryType=r.webSocketBinaryType),r.connectTimeout>0&&(r.id=setTimeout(function(){if(!t){var e={code:1002,reason:"",wasClean:!1};u.onclose(e);try{M()}catch(n){}return}},r.connectTimeout)),u.onopen=function(i){k("websocket.onopen"),$(r),n=!1,C("debug")&&e.util.debug("Websocket successfully opened");var s=t;u!=null&&(u.canSendMessage=!0),r.enableProtocol||(t=!0,s?I("re-opening","websocket",r):I("opening","websocket",r)),u!=null&&r.method==="POST"&&(o.state="messageReceived",u.send(r.data))},u.onmessage=function(e){k("websocket.onmessage"),$(r),r.enableProtocol&&(t=!0),o.state="messageReceived",o.status=200,e=e.data;var n=typeof e=="string";if(n){var i=Q(e,r,o);i||(kt(),o.responseBody="",o.messages=[])}else{e=V(r,e);if(e==="")return;o.responseBody=e,kt(),o.responseBody=null}},u.onerror=function(e){k("websocket.onerror"),clearTimeout(r.id),r.heartbeatTimer&&clearTimeout(r.heartbeatTimer),r.curWebsocketErrorRetries++<r.maxWebsocketErrorRetries&&r.fallbackTransport!=="websocket"&&G("Failed to connect via Websocket. Downgrading to "+r.fallbackTransport+" and resending")},u.onclose=function(i){k("websocket.onclose"),clearTimeout(r.id);if(o.state==="closed")return;var s=i.reason;if(s==="")switch(i.code){case 1e3:s="Normal closure; the connection successfully completed whatever purpose for which it was created.";break;case 1001:s="The endpoint is going away, either because of a server failure or because the browser is navigating away from the page that opened the connection.";break;case 1002:s="The endpoint is terminating the connection due to a protocol error.";break;case 1003:s="The connection is being terminated because the endpoint received data of a type it cannot accept (for example, a text-only endpoint received binary data).";break;case 1004:s="The endpoint is terminating the connection because a data frame was received that is too large.";break;case 1005:s="Unknown: no status code was provided even though one was expected.";break;case 1006:s="Connection was closed abnormally (that is, with no close frame being sent)."}C("warn")&&e.util.warn("Websocket closed, reason: "+s+" - wasClean: "+i.wasClean);if(o.closedByClientTimeout||r.handleOnlineOffline&&n){r.reconnectId&&(clearTimeout(r.reconnectId),delete r.reconnectId);return}Ct(t),o.state="closed",m?e.util.log(r.logLevel,["Websocket closed normally"]):!t&&r.fallbackTransport!=="websocket"?G("Websocket failed on first connection attempt. Downgrading to "+r.fallbackTransport+" and resending"):r.reconnect&&o.transport==="websocket"&&(M(),p++<r.maxReconnectOnClose?(I("re-connecting",r.transport,r),r.reconnectInterval>0?r.reconnectId=setTimeout(function(){o.responseBody="",o.messages=[],X(!0)},r.reconnectInterval):(o.responseBody="",o.messages=[],X(!0))):(e.util.log(r.logLevel,["Websocket reconnect maximum try reached "+p]),C("warn")&&e.util.warn("Websocket error, reason: "+i.reason),K(0,"maxReconnectOnClose reached")))};var s=navigator.userAgent.toLowerCase(),a=s.indexOf("android")>-1;a&&u.url===undefined&&u.onclose({reason:"Android 4.1 does not support websockets.",wasClean:!1})}function V(t,n){var i=n;if(t.transport==="polling")return i;if(t.enableProtocol&&t.firstMessage&&e.util.trim(n).length!==0){var o=t.trackMessageLength?1:0,u=n.split(t.messageDelimiter);if(u.length<=o+1)return i;t.firstMessage=!1,t.uuid=e.util.trim(u[o]),u.length<=o+2&&e.util.log("error",["Protocol data not sent by the server. If you enable protocol on client side, be sure to install JavascriptProtocol interceptor on server side.Also note that atmosphere-runtime 2.2+ should be used."]),d=parseInt(e.util.trim(u[o+1]),10),v=u[o+2],t.transport!=="long-polling"&&Z(t),s=t.uuid,i="",o=t.trackMessageLength?4:3;if(u.length>o+1)for(var a=o;a<u.length;a++)i+=u[a],a+1!==u.length&&(i+=t.messageDelimiter);t.ackInterval!==0&&setTimeout(function(){ct("...ACK...")},t.ackInterval)}else t.enableProtocol&&t.firstMessage&&e.util.browser.msie&&+e.util.browser.version.split(".")[0]<10?e.util.log(r.logLevel,["Receiving unexpected data from IE"]):Z(t);return i}function $(e){clearTimeout(e.id),e.timeout>0&&e.transport!=="polling"&&(e.id=setTimeout(function(){J(e),A(),M()},e.timeout))}function J(e){o.closedByClientTimeout=!0,o.state="closedByClient",o.responseBody="",o.status=408,o.messages=[],kt()}function K(e,t){M(),clearTimeout(r.id),o.state="error",o.reasonPhrase=t,o.responseBody="",o.status=e,o.messages=[],kt()}function Q(e,t,n){e=V(t,e);if(e.length===0)return!0;n.responseBody=e;if(t.trackMessageLength){e=n.partialMessage+e;var r=[],i=e.indexOf(t.messageDelimiter);if(i!=-1){while(i!==-1){var s=e.substring(0,i),o=+s;if(isNaN(o))throw n.partialMessage="",new Error('message length "'+s+'" is not a number');i+=t.messageDelimiter.length,i+o>e.length?i=-1:(r.push(e.substring(i,i+o)),e=e.substring(i+o,e.length),i=e.indexOf(t.messageDelimiter))}return n.partialMessage=e,r.length!==0?(n.responseBody=r.join(t.messageDelimiter),n.messages=r,!1):(n.responseBody="",n.messages=[],!0)}}return n.responseBody=e,n.messages=[e],!1}function G(t){e.util.log(r.logLevel,[t]),typeof r.onTransportFailure!="undefined"?r.onTransportFailure(t,r):typeof e.util.onTransportFailure!="undefined"&&e.util.onTransportFailure(t,r);var n=r.connectTimeout===-1?0:r.connectTimeout;r.reconnect&&r.transport!=="none"||r.transport==null?(r.transport=r.fallbackTransport,r.method=r.fallbackMethod,o.transport=r.fallbackTransport,o.state="",r.fallbackTransport="none",n>0?r.reconnectId=setTimeout(function(){B()},n):B()):K(500,"Unable to reconnect with fallback transport")}function Y(t,n){var i=r;return t!=null&&typeof t!="undefined"&&(i=t),n==null&&(n=i.url),i.attachHeadersAsQueryString?n.indexOf("X-Atmosphere-Framework")!==-1?n:(n+=n.indexOf("?")!==-1?"&":"?",n+="X-Atmosphere-tracking-id="+i.uuid,n+="&X-Atmosphere-Framework="+e.version,n+="&X-Atmosphere-Transport="+i.transport,i.trackMessageLength&&(n+="&X-Atmosphere-TrackMessageSize=true"),i.heartbeat!==null&&i.heartbeat.server!==null&&(n+="&X-Heartbeat-Server="+i.heartbeat.server),i.contentType!==""&&(n+="&Content-Type="+(i.transport==="websocket"?i.contentType:encodeURIComponent(i.contentType))),i.enableProtocol&&(n+="&X-atmo-protocol=true"),e.util.each(i.headers,function(r,s){var u=e.util.isFunction(s)?s.call(this,i,t,o):s;u!=null&&(n+="&"+encodeURIComponent(r)+"="+encodeURIComponent(u))}),n):n}function Z(e){if(!e.isOpen)e.isOpen=!0,I("opening",e.transport,e);else if(e.isReopen)e.isReopen=!1,I("re-opening",e.transport,e);else{if(o.state!=="messageReceived"||e.transport!=="jsonp"&&e.transport!=="long-polling")return;ot(o)}et(e)}function et(t){t.heartbeatTimer!=null&&clearTimeout(t.heartbeatTimer);if(!isNaN(d)&&d>0){var n=function(){C("debug")&&e.util.debug("Sending heartbeat"),ct(v),t.heartbeatTimer=setTimeout(n,d)};t.heartbeatTimer=setTimeout(n,d)}}function tt(t){var n=r;if(t!=null||typeof t!="undefined")n=t;n.lastIndex=0,n.readyState=0;if(n.transport==="jsonp"||n.enableXDR&&e.util.checkCORSSupport()){q(n);return}if(e.util.browser.msie&&+e.util.browser.version.split(".")[0]<10){if(n.transport==="streaming"){n.enableXDR&&window.XDomainRequest?ut(n):ft(n);return}if(n.enableXDR&&window.XDomainRequest){ut(n);return}}var i=function(e){n.lastIndex=0,p++;if(e||n.reconnect&&p<=n.maxReconnectOnClose){var r=e?0:t.reconnectInterval;o.ffTryingReconnect=!0,I("re-connecting",t.transport,t),it(a,n,r)}else K(0,"maxReconnectOnClose reached")},s=function(t){e._beforeUnloadState?(e.util.debug(new Date+" Atmosphere: reconnectF: execution delayed due to _beforeUnloadState flag"),setTimeout(function(){i(t)},5e3)):i(t)},u=function(){o.errorHandled=!0,M(),s(!1)};if(n.force||n.reconnect&&(n.maxRequest===-1||n.requestCount++<n.maxRequest)){n.force=!1;var a=e.util.xhr();a.hasData=!1,rt(a,n,!0),n.suspend&&(f=a),n.transport!=="polling"&&(o.transport=n.transport,a.onabort=function(){k("ajaxrequest.onabort"),Ct(!0)},a.onerror=function(){k("ajaxrequest.onerror"),o.error=!0,o.ffTryingReconnect=!0;try{o.status=XMLHttpRequest.status}catch(e){o.status=500}o.status||(o.status=500),o.errorHandled||(M(),s(!1))}),a.onreadystatechange=function(){k("ajaxRequest.onreadystatechange, new state: "+a.readyState);if(m){k("onreadystatechange has been ignored due to _abortingConnection flag");return}o.error=null;var i=!1,f=!1;if(n.transport==="streaming"&&n.readyState>2&&a.readyState===4){M(),s(!1);return}n.readyState=a.readyState,n.transport==="streaming"&&a.readyState>=3?f=!0:n.transport==="long-polling"&&a.readyState===4&&(f=!0),$(r);if(n.transport!=="polling"){var l=200;a.readyState===4&&(l=a.status>1e3?0:a.status);if(!n.reconnectOnServerError&&l>=300&&l<600){K(l,a.statusText);return}if(l>=300||l===0){u();return}(!n.enableProtocol||!t.firstMessage)&&a.readyState===2&&(e.util.browser.mozilla&&o.ffTryingReconnect?(o.ffTryingReconnect=!1,setTimeout(function(){o.ffTryingReconnect||Z(n)},500)):Z(n))}else a.readyState===4&&(f=!0);if(f){var c=a.responseText;o.errorHandled=!1;if(n.transport==="long-polling"&&e.util.trim(c).length===0){a.hasData?a.hasData=!1:s(!0);return}a.hasData=!0,xt(a,r);if(n.transport==="streaming")if(!e.util.browser.opera){var h=c.substring(n.lastIndex,c.length);i=Q(h,n,o),n.lastIndex=c.length;if(i)return}else e.util.iterate(function(){if(o.status!==500&&a.responseText.length>n.lastIndex){try{o.status=a.status,o.headers=e.util.parseHeaders(a.getAllResponseHeaders()),xt(a,r)}catch(t){o.status=404}$(r),o.state="messageReceived";var s=a.responseText.substring(n.lastIndex);n.lastIndex=a.responseText.length,i=Q(s,n,o),i||kt();if(L(a,n)){nt(a,n);return}}else if(o.status>400)return n.lastIndex=a.responseText.length,!1},0);else i=Q(c,n,o);var p=L(a,n);try{o.status=a.status,o.headers=e.util.parseHeaders(a.getAllResponseHeaders()),xt(a,n)}catch(d){o.status=404}n.suspend?o.state=o.status===0?"closed":"messageReceived":o.state="messagePublished";var v=!p&&t.transport!=="streaming"&&t.transport!=="polling";v&&!n.executeCallbackBeforeReconnect&&it(a,n,n.pollingInterval),o.responseBody.length!==0&&!i&&kt(),v&&n.executeCallbackBeforeReconnect&&it(a,n,n.pollingInterval),p&&nt(a,n)}};try{a.send(n.data),h=!0}catch(l){e.util.log(n.logLevel,["Unable to connect to "+n.url]),K(0,l)}}else n.logLevel==="debug"&&e.util.log(n.logLevel,["Max re-connection reached."]),K(0,"maxRequest reached")}function nt(e,t){o.messages=[],t.isReopen=!0,O(),m=!1,it(e,t,500)}function rt(t,n,i){var s=n.url;n.dispatchUrl!=null&&n.method==="POST"&&(s+=n.dispatchUrl),s=Y(n,s),s=e.util.prepareURL(s),i&&(t.open(n.method,s,n.async),n.connectTimeout>0&&(n.id=setTimeout(function(){n.requestCount===0&&(M(),St("Connect timeout","closed",200,n.transport))},n.connectTimeout))),r.withCredentials&&r.transport!=="websocket"&&"withCredentials"in t&&(t.withCredentials=!0),r.dropHeaders||(t.setRequestHeader("X-Atmosphere-Framework",e.version),t.setRequestHeader("X-Atmosphere-Transport",n.transport),n.heartbeat!==null&&n.heartbeat.server!==null&&t.setRequestHeader("X-Heartbeat-Server",t.heartbeat.server),n.trackMessageLength&&t.setRequestHeader("X-Atmosphere-TrackMessageSize","true"),t.setRequestHeader("X-Atmosphere-tracking-id",n.uuid),e.util.each(n.headers,function(r,s){var u=e.util.isFunction(s)?s.call(this,t,n,i,o):s;u!=null&&t.setRequestHeader(r,u)})),n.contentType!==""&&t.setRequestHeader("Content-Type",n.contentType)}function it(e,t,n){if(o.closedByClientTimeout)return;if(t.reconnect||t.suspend&&h){var i=0;e&&e.readyState>1&&(i=e.status>1e3?0:e.status),o.status=i===0?204:i,o.reason=i===0?"Server resumed the connection or down.":"OK",clearTimeout(t.id),t.reconnectId&&(clearTimeout(t.reconnectId),delete t.reconnectId),n>0?r.reconnectId=setTimeout(function(){tt(t)},n):tt(t)}}function st(e){e.state="re-connecting",Tt(e)}function ot(e){e.state="openAfterResume",Tt(e),e.state="messageReceived"}function ut(e){e.transport!=="polling"?(l=at(e),l.open()):at(e).open()}function at(t){var n=r;t!=null&&typeof t!="undefined"&&(n=t);var i=n.transport,s=0,u=new window.XDomainRequest,a=function(){n.transport==="long-polling"&&n.reconnect&&(n.maxRequest===-1||n.requestCount++<n.maxRequest)&&(u.status=200,ut(n))},f=n.rewriteURL||function(e){var t=/(?:^|;\s*)(JSESSIONID|PHPSESSID)=([^;]*)/.exec(document.cookie);switch(t&&t[1]){case"JSESSIONID":return e.replace(/;jsessionid=[^\?]*|(\?)|$/,";jsessionid="+t[2]+"$1");case"PHPSESSID":return e.replace(/\?PHPSESSID=[^&]*&?|\?|$/,"?PHPSESSID="+t[2]+"&").replace(/&$/,"")}return e};u.onprogress=function(){l(u)},u.onerror=function(){n.transport!=="polling"&&(M(),p++<n.maxReconnectOnClose?n.reconnectInterval>0?n.reconnectId=setTimeout(function(){I("re-connecting",t.transport,t),ut(n)},n.reconnectInterval):(I("re-connecting",t.transport,t),ut(n)):K(0,"maxReconnectOnClose reached"))},u.onload=function(){};var l=function(t){clearTimeout(n.id);var r=t.responseText;r=r.substring(s),s+=r.length;if(i!=="polling"){$(n);var u=Q(r,n,o);if(i==="long-polling"&&e.util.trim(r).length===0)return;n.executeCallbackBeforeReconnect&&a(),u||St(o.responseBody,"messageReceived",200,i),n.executeCallbackBeforeReconnect||a()}};return{open:function(){var e=n.url;n.dispatchUrl!=null&&(e+=n.dispatchUrl),e=Y(n,e),u.open(n.method,f(e)),n.method==="GET"?u.send():u.send(n.data),n.connectTimeout>0&&(n.id=setTimeout(function(){n.requestCount===0&&(M(),St("Connect timeout","closed",200,n.transport))},n.connectTimeout))},close:function(){u.abort()}}}function ft(e){l=lt(e),l.open()}function lt(t){var n=r;t!=null&&typeof t!="undefined"&&(n=t);var i,s=new window.ActiveXObject("htmlfile");s.open(),s.close();var u=n.url;return n.dispatchUrl!=null&&(u+=n.dispatchUrl),n.transport!=="polling"&&(o.transport=n.transport),{open:function(){var t=s.createElement("iframe");u=Y(n),n.data!==""&&(u+="&X-Atmosphere-Post-Body="+encodeURIComponent(n.data)),u=e.util.prepareURL(u),t.src=u,s.body.appendChild(t);var a=t.contentDocument||t.contentWindow.document;i=e.util.iterate(function(){try{if(!a.firstChild)return;var t=a.body?a.body.lastChild:a;t.omgThisIsBroken;var u=function(){var e=t.cloneNode(!0);e.appendChild(a.createTextNode("."));var n=e.innerText;return n=n.substring(0,n.length-1),n};if(!a.body||!a.body.firstChild||a.body.firstChild.nodeName.toLowerCase()!=="pre"){var f=a.head||a.getElementsByTagName("head")[0]||a.documentElement||a,l=a.createElement("script");l.text="document.write('<plaintext>')",f.insertBefore(l,f.firstChild),f.removeChild(l),t=a.body.lastChild}return n.closed&&(n.isReopen=!0),i=e.util.iterate(function(){var e=u();if(e.length>n.lastIndex){$(r),o.status=200,o.error=null,t.innerText="";var i=Q(e,n,o);if(i)return"";St(o.responseBody,"messageReceived",200,n.transport)}n.lastIndex=0;if(a.readyState==="complete")return Ct(!0),I("re-connecting",n.transport,n),n.reconnectInterval>0?n.reconnectId=setTimeout(function(){ft(n)},n.reconnectInterval):ft(n),!1},null),!1}catch(c){return o.error=!0,I("re-connecting",n.transport,n),p++<n.maxReconnectOnClose?n.reconnectInterval>0?n.reconnectId=setTimeout(function(){ft(n)},n.reconnectInterval):ft(n):K(0,"maxReconnectOnClose reached"),s.execCommand("Stop"),s.close(),!1}})},close:function(){i&&i(),s.execCommand("Stop"),Ct(!0)}}}function ct(t){b!=null?pt(t):f!=null||a!=null?vt(t):l!=null?mt(t):c!=null?gt(t):u!=null?wt(t):(K(0,"No suspended connection available"),e.util.error("No suspended connection available. Make sure atmosphere.subscribe has been called and request.onOpen invoked before trying to push data"))}function ht(e,t){t||(t=bt(e)),t.transport="polling",t.method="GET",t.withCredentials=!1,t.reconnect=!1,t.force=!0,t.suspend=!1,t.timeout=1e3,tt(t)}function pt(e){b.send(e)}function dt(t){if(t.length===0)return;try{b?b.localSend(t):y&&y.signal("localMessage",JSON.stringify({id:w,event:t}))}catch(n){e.util.error(n)}}function vt(e){var t=bt(e);tt(t)}function mt(t){if(r.enableXDR&&e.util.checkCORSSupport()){var n=bt(t);n.reconnect=!1,q(n)}else vt(t)}function gt(e){vt(e)}function yt(e){var t=e;return typeof t=="object"&&(t=e.data),t}function bt(t){var n=yt(t),i={connected:!1,timeout:6e4,method:"POST",url:r.url,contentType:r.contentType,headers:r.headers,reconnect:!0,callback:null,data:n,suspend:!1,maxRequest:-1,logLevel:"info",requestCount:0,withCredentials:r.withCredentials,async:r.async,transport:"polling",isOpen:!0,attachHeadersAsQueryString:!0,enableXDR:r.enableXDR,uuid:r.uuid,dispatchUrl:r.dispatchUrl,enableProtocol:!1,messageDelimiter:"|",trackMessageLength:r.trackMessageLength,maxReconnectOnClose:r.maxReconnectOnClose,heartbeatTimer:r.heartbeatTimer,heartbeat:r.heartbeat};return typeof t=="object"&&(i=e.util.extend(i,t)),i}function wt(t){var n=e.util.isBinary(t)?t:yt(t),i;try{r.dispatchUrl!=null?i=r.webSocketPathDelimiter+r.dispatchUrl+r.webSocketPathDelimiter+n:i=n;if(!u.canSendMessage){e.util.error("WebSocket not connected.");return}u.send(i)}catch(s){u.onclose=function(e){},M(),G("Websocket failed. Downgrading to "+r.fallbackTransport+" and resending "+t),vt(t)}}function Et(t){var n=JSON.parse(t);n.id!==w&&(typeof r.onLocalMessage!="undefined"?r.onLocalMessage(n.event):typeof e.util.onLocalMessage!="undefined"&&e.util.onLocalMessage(n.event))}function St(e,t,n,r){o.responseBody=e,o.transport=r,o.status=n,o.state=t,kt()}function xt(e,t){if(!t.readResponsesHeaders)t.enableProtocol||(t.uuid=w);else try{var n=e.getResponseHeader("X-Atmosphere-tracking-id");n&&n!=null&&(t.uuid=n.split(" ").pop())}catch(r){}}function Tt(t){Nt(t,r),Nt(t,e.util)}function Nt(e,t){switch(e.state){case"messageReceived":k("Firing onMessage"),p=0,typeof t.onMessage!="undefined"&&t.onMessage(e),typeof t.onmessage!="undefined"&&t.onmessage(e);break;case"error":var n=typeof e.reasonPhrase!="undefined"?e.reasonPhrase:"n/a";k("Firing onError, reasonPhrase: "+n),typeof t.onError!="undefined"&&t.onError(e),typeof t.onerror!="undefined"&&t.onerror(e);break;case"opening":delete r.closed,k("Firing onOpen"),typeof t.onOpen!="undefined"&&t.onOpen(e),typeof t.onopen!="undefined"&&t.onopen(e);break;case"messagePublished":k("Firing messagePublished"),typeof t.onMessagePublished!="undefined"&&t.onMessagePublished(e);break;case"re-connecting":k("Firing onReconnect"),typeof t.onReconnect!="undefined"&&t.onReconnect(r,e);break;case"closedByClient":k("Firing closedByClient"),typeof t.onClientTimeout!="undefined"&&t.onClientTimeout(r);break;case"re-opening":delete r.closed,k("Firing onReopen"),typeof t.onReopen!="undefined"&&t.onReopen(r,e);break;case"fail-to-reconnect":k("Firing onFailureToReconnect"),typeof t.onFailureToReconnect!="undefined"&&t.onFailureToReconnect(r,e);break;case"unsubscribe":case"closed":var i=typeof r.closed!="undefined"?r.closed:!1;i?k("Request already closed, not firing onClose ("+e.state+" case)"):(k("Firing onClose ("+e.state+" case)"),typeof t.onClose!="undefined"&&t.onClose(e),typeof t.onclose!="undefined"&&t.onclose(e)),r.closed=!0;break;case"openAfterResume":typeof t.onOpenAfterResume!="undefined"&&t.onOpenAfterResume(r)}}function Ct(e){o.state!=="closed"&&(o.state="closed",o.responseBody="",o.messages=[],o.status=e?200:501,kt())}function kt(){var t=function(e,t){t(o)};b==null&&g!=null&&g(o.responseBody),r.reconnect=r.mrequest;var n=typeof o.responseBody=="string",s=n&&r.trackMessageLength?o.messages.length>0?o.messages:[""]:new Array(o.responseBody);for(var u=0;u<s.length;u++){if(s.length>1&&s[u].length===0)continue;o.responseBody=n?e.util.trim(s[u]):s[u],b==null&&g!=null&&g(o.responseBody);if((o.responseBody.length===0||n&&v===o.responseBody)&&o.state==="messageReceived")continue;Tt(o);if(i.length>0){C("debug")&&e.util.debug("Invoking "+i.length+" global callbacks: "+o.state);try{e.util.each(i,t)}catch(a){e.util.log(r.logLevel,["Callback exception"+a])}}if(typeof r.callback=="function"){C("debug")&&e.util.debug("Invoking request callbacks");try{r.callback(o)}catch(a){e.util.log(r.logLevel,["Callback exception"+a])}}}}var r={timeout:3e5,method:"GET",headers:{},contentType:"",callback:null,url:"",data:"",suspend:!0,maxRequest:-1,reconnect:!0,maxStreamingLength:1e7,lastIndex:0,logLevel:"info",requestCount:0,fallbackMethod:"GET",fallbackTransport:"streaming",transport:"long-polling",webSocketImpl:null,webSocketBinaryType:null,dispatchUrl:null,webSocketPathDelimiter:"@@",enableXDR:!1,rewriteURL:!1,attachHeadersAsQueryString:!0,executeCallbackBeforeReconnect:!1,readyState:0,withCredentials:!1,trackMessageLength:!1,messageDelimiter:"|",connectTimeout:-1,reconnectInterval:0,dropHeaders:!0,uuid:0,async:!0,shared:!1,readResponsesHeaders:!1,maxReconnectOnClose:5,enableProtocol:!0,disableDisconnect:!1,pollingInterval:0,heartbeat:{client:null,server:null},ackInterval:0,closeAsync:!1,reconnectOnServerError:!0,handleOnlineOffline:!0,maxWebsocketErrorRetries:1,curWebsocketErrorRetries:0,onError:function(e){},onClose:function(e){},onOpen:function(e){},onMessage:function(e){},onReopen:function(e,t){},onReconnect:function(e,t){},onMessagePublished:function(e){},onTransportFailure:function(e,t){},onLocalMessage:function(e){},onFailureToReconnect:function(e,t){},onClientTimeout:function(e){},onOpenAfterResume:function(e){}},o={status:200,reasonPhrase:"OK",responseBody:"",messages:[],headers:[],state:"messageReceived",transport:"polling",error:null,request:null,partialMessage:"",errorHandled:!1,closedByClientTimeout:!1,ffTryingReconnect:!1},u=null,a=null,f=null,l=null,c=null,h=!0,p=0,d=0,v="X",m=!1,g=null,y,b=null,w=e.util.now(),E,S,x=!1;D(t),this.subscribe=function(e){D(e),B()},this.execute=function(){B()},this.close=function(){O()},this.disconnect=function(){A()},this.getUrl=function(){return r.url},this.push=function(e,t){if(t!=null){var n=r.dispatchUrl;r.dispatchUrl=t,ct(e),r.dispatchUrl=n}else ct(e)},this.getUUID=function(){return r.uuid},this.pushLocal=function(e){dt(e)},this.enableProtocol=function(e){return r.enableProtocol},this.init=function(){T()},this.request=r,this.response=o}},e.subscribe=function(t,n,i){typeof n=="function"&&e.addCallback(n),typeof t!="string"?i=t:i.url=t,s=typeof i!="undefined"&&typeof i.uuid!="undefined"?i.uuid:0;var o=new e.AtmosphereRequest(i);return o.execute(),r[r.length]=o,o},e.unsubscribe=function(){if(r.length>0){var e=[].concat(r);for(var t=0;t<e.length;t++){var n=e[t];n.close(),clearTimeout(n.response.request.id),n.heartbeatTimer&&clearTimeout(n.heartbeatTimer)}}r=[],i=[]},e.unsubscribeUrl=function(e){var t=-1;if(r.length>0)for(var n=0;n<r.length;n++){var i=r[n];if(i.getUrl()===e){i.close(),clearTimeout(i.response.request.id),i.heartbeatTimer&&clearTimeout(i.heartbeatTimer),t=n;break}}t>=0&&r.splice(t,1)},e.addCallback=function(t){e.util.inArray(t,i)===-1&&i.push(t)},e.removeCallback=function(t){var n=e.util.inArray(t,i);n!==-1&&i.splice(n,1)},e.util={browser:{},parseHeaders:function(e){var t,n=/^(.*?):[ \t]*([^\r\n]*)\r?$/mg,r={};while(t=n.exec(e))r[t[1]]=t[2];return r},now:function(){return(new Date).getTime()},isArray:function(e){return Object.prototype.toString.call(e)==="[object Array]"},inArray:function(e,t){if(!Array.prototype.indexOf){var n=t.length;for(var r=0;r<n;++r)if(t[r]===e)return r;return-1}return t.indexOf(e)},isBinary:function(e){return/^\[object\s(?:Blob|ArrayBuffer|.+Array)\]$/.test(Object.prototype.toString.call(e))},isFunction:function(e){return Object.prototype.toString.call(e)==="[object Function]"},getAbsoluteURL:function(e){if(typeof document.createElement=="undefined")return e;var t=document.createElement("div");return t.innerHTML='<a href="'+e+'"/>',encodeURI(decodeURI(t.firstChild.href))},prepareURL:function(t){var n=e.util.now(),r=t.replace(/([?&])_=[^&]*/,"$1_="+n);return r+(r===t?(/\?/.test(t)?"&":"?")+"_="+n:"")},trim:function(e){return String.prototype.trim?e.toString().trim():e.toString().replace(/(?:(?:^|\n)\s+|\s+(?:$|\n))/g,"").replace(/\s+/g," ")},param:function(t){function i(t,n){n=e.util.isFunction(n)?n():n==null?"":n,r.push(encodeURIComponent(t)+"="+encodeURIComponent(n))}function s(t,n){var r;if(e.util.isArray(n))e.util.each(n,function(e,n){/\[\]$/.test(t)?i(t,n):s(t+"["+(typeof n=="object"?e:"")+"]",n)});else if(Object.prototype.toString.call(n)==="[object Object]")for(r in n)s(t+"["+r+"]",n[r]);else i(t,n)}var n,r=[];for(n in t)s(n,t[n]);return r.join("&").replace(/%20/g,"+")},storage:function(){try{return!!window.localStorage&&!!window.StorageEvent}catch(e){return!1}},iterate:function(e,t){var n;return t=t||0,function r(){n=setTimeout(function(){if(e()===!1)return;r()},t)}(),function(){clearTimeout(n)}},each:function(t,n,r){if(!t)return;var i,s=0,o=t.length,u=e.util.isArray(t);if(r)if(u)for(;s<o;s++){i=n.apply(t[s],r);if(i===!1)break}else for(s in t){i=n.apply(t[s],r);if(i===!1)break}else if(u)for(;s<o;s++){i=n.call(t[s],s,t[s]);if(i===!1)break}else for(s in t){i=n.call(t[s],s,t[s]);if(i===!1)break}return t},extend:function(e){var t,n,r;for(t=1;t<arguments.length;t++)if((n=arguments[t])!=null)for(r in n)e[r]=n[r];return e},on:function(e,t,n){e.addEventListener?e.addEventListener(t,n,!1):e.attachEvent&&e.attachEvent("on"+t,n)},off:function(e,t,n){e.removeEventListener?e.removeEventListener(t,n,!1):e.detachEvent&&e.detachEvent("on"+t,n)},log:function(e,t){if(window.console){var n=window.console[e];typeof n=="function"&&n.apply(window.console,t)}},warn:function(){e.util.log("warn",arguments)},info:function(){e.util.log("info",arguments)},debug:function(){e.util.log("debug",arguments)},error:function(){e.util.log("error",arguments)},xhr:function(){try{return new window.XMLHttpRequest}catch(e){try{return new window.ActiveXObject("Microsoft.XMLHTTP")}catch(t){}}},checkCORSSupport:function(){if(e.util.browser.msie&&!window.XDomainRequest&&+e.util.browser.version.split(".")[0]<11)return!0;if(e.util.browser.opera&&+e.util.browser.version.split(".")<12)return!0;if(e.util.trim(navigator.userAgent).slice(0,16)==="KreaTVWebKit/531")return!0;if(e.util.trim(navigator.userAgent).slice(-7).toLowerCase()==="kreatel")return!0;var t=navigator.userAgent.toLowerCase(),n=t.match(/.+android ([0-9]{1,2})/i),r=parseInt(n&&n[0]||-1,10);return!isNaN(r)&&r>-1&&r<3?!0:!1}},t=e.util.now(),function(){var t=navigator.userAgent.toLowerCase(),n=/(chrome)[ \/]([\w.]+)/.exec(t)||/(opera)(?:.*version|)[ \/]([\w.]+)/.exec(t)||/(msie) ([\w.]+)/.exec(t)||/(trident)(?:.*? rv:([\w.]+)|)/.exec(t)||t.indexOf("android")<0&&/version\/(.+) (safari)/.exec(t)||t.indexOf("compatible")<0&&/(mozilla)(?:.*? rv:([\w.]+)|)/.exec(t)||[];n[2]==="safari"&&(n[2]=n[1],n[1]="safari"),e.util.browser[n[1]||""]=!0,e.util.browser.version=n[2]||"0",e.util.browser.vmajor=e.util.browser.version.split(".")[0],e.util.browser.trident&&(e.util.browser.msie=!0);if(e.util.browser.msie||e.util.browser.mozilla&&+e.util.browser.version.split(".")[0]===1)e.util.storage=!1}(),e.callbacks={unload:function(){e.util.debug(new Date+" Atmosphere: "+"unload event"),e.unsubscribe()},beforeUnload:function(){e.util.debug(new Date+" Atmosphere: "+"beforeunload event"),e._beforeUnloadState=!0,setTimeout(function(){e.util.debug(new Date+" Atmosphere: "+"beforeunload event timeout reached. Reset _beforeUnloadState flag"),e._beforeUnloadState=!1},5e3)},offline:function(){e.util.debug(new Date+" Atmosphere: offline event"),n=!0;if(r.length>0){var t=[].concat(r);for(var i=0;i<t.length;i++){var s=t[i];s.request.handleOnlineOffline&&(s.close(),clearTimeout(s.response.request.id),s.heartbeatTimer&&clearTimeout(s.heartbeatTimer))}}},online:function(){e.util.debug(new Date+" Atmosphere: online event");if(r.length>0)for(var t=0;t<r.length;t++)r[t].request.handleOnlineOffline&&(r[t].init(),r[t].execute());n=!1}},e.bindEvents=function(){e.util.on(window,"unload",e.callbacks.unload),e.util.on(window,"beforeunload",e.callbacks.beforeUnload),e.util.on(window,"offline",e.callbacks.offline),e.util.on(window,"online",e.callbacks.online)},e.unbindEvents=function(){e.util.off(window,"unload",e.callbacks.unload),e.util.off(window,"beforeunload",e.callbacks.beforeUnload),e.util.off(window,"offline",e.callbacks.offline),e.util.off(window,"online",e.callbacks.online)},e.bindEvents(),e});